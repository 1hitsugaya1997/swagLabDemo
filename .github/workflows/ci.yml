# üìÑ –ù–∞–∑–≤–∞–Ω–∏–µ workflow, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ GitHub Actions
name: Java CI with Maven + Debug

# üßØ –¢—Ä–∏–≥–≥–µ—Ä—ã ‚Äî –ø—Ä–∏ –∫–∞–∫–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö –∑–∞–ø—É—Å–∫–∞—Ç—å workflow
on:
  push:                     # üîÅ –ü—Ä–∏ –ø—É—à–µ –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤–µ—Ç–∫–∏
    branches: [ main ]
  pull_request:             # üîÉ –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Pull Request –≤ —ç—Ç–∏ –≤–µ—Ç–∫–∏
    branches: [ main ]
  workflow_dispatch:        # üîß –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  schedule:                 # ‚è∞ –ü–ª–∞–Ω–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (CRON —Ñ–æ—Ä–º–∞—Ç)
    - cron: '0 6 * * 1'     # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 06:00 UTC

# üöß –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã (job)
jobs:
  build:
    runs-on: ubuntu-24.04   # ‚òÅÔ∏è –ù–∞ –∫–∞–∫–æ–π –º–∞—à–∏–Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å job (–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ GitHub)

    steps:
      # üì• –®–∞–≥ 1. –°–∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout code
        uses: actions/checkout@v4

      # ‚òï –®–∞–≥ 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å JDK 17 (Temurin ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å–±–æ—Ä–∫–∞ OpenJDK)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      # üíæ –®–∞–≥ 3. –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Maven (—É—Å–∫–æ—Ä—è–µ—Ç —Å–±–æ—Ä–∫—É)
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository             # üì¶ –ü—É—Ç—å –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é Maven
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # üß™ –®–∞–≥ 4. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ Maven —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –ª–æ–≥–æ–º
      - name: Run tests with debug output
        run: mvn clean verify --batch-mode -e -X || true
        # --batch-mode: –Ω–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
        # -e: –ø–æ–∫–∞–∑–∞—Ç—å stacktrace –æ—à–∏–±–æ–∫
        # -X: –ø–æ–ª–Ω—ã–π –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
        # || true ‚Äî —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏

      # üìÑ –®–∞–≥ 5. –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ –∏–∑ –ª–æ–≥–æ–≤ Surefire (–¥–∞–∂–µ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏)
      - name: Display error logs from Surefire
        if: always()                         # üí° –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤
        run: |
          echo "=== Surefire STDERR/STDOUT Logs ==="
          for f in target/surefire-reports/*.txt; do
            echo "----- $f -----"
            tail -n 100 "$f"
          done

      # üì§ –®–∞–≥ 6. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ª–æ–≥–æ–≤ Surefire (JUnit –æ—Ç—á—ë—Ç—ã)
      - name: Upload Surefire reports
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/

      # üì§ –®–∞–≥ 7. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã Allure –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –≤ CI
      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results/
